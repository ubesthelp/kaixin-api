# API 签名算法

以下部分内容复制自阿里云 API 网关《[客户端签名说明文档](https://help.aliyun.com/document_detail/29475.html)》与 Lazada Open Platform《[Signature Algorithm](https://open.lazada.com/doc/doc.htm#?nodeId=10450&docId=108068)》。

## 签名与验签原理

客户端调用 API 时，需要使用已授权签名密钥对请求内容的关键数据进行加密签名计算，并且将 APP Key 和加密后生成的字符串放在请求的 URL 查询字符串中。API 会读取请求中的 APP Key，并且根据 APP Key 的值查询到对应的APP Secret 的值；使用 APP Secret 对收到的请求中的关键数据进行签名计算，并且使用自己的生成的签名和客户端传上来的签名进行比对，来验证签名的正确性。只有签名验证通过的请求才能得到正确响应，否则该请求将被视为非法，直接返回错误应答。

### 前置条件

API 调用方需要在调用 API 之前获取到已经授权给对应 APP 的签名密钥对：

- APP Key
- APP Secret

### 客户端生成签名

客户端生成签名一共分 3 步处理：

1. 从原始请求中提取关键数据，得到一个用来签名的字符串；
2. 使用加密算法加 APP Secret 对关键数据签名串进行加密处理，得到签名；
3. 将签名所相关的所有字段加入到 URL 查询字符串中，得到最终 HTTP 请求。

### 服务器端验证签名

服务器验证客户端签名一共分 4 步处理：

1. 从接收到的请求中提取关键数据，得到一个用来签名的字符串；
2. 从接收到的请求中读取 APP Key，通过 APP Key 查询到对应的 APP Secret；
3. 使用加密算法和 APP Secret 对关键数据签名串进行加密处理，得到签名；
4. 从接收到的请求中读取客户端签名，对比服务器端签名和客户端签名的一致性。

## 生成与传递签名

### 提取签名串

客户端需要从 HTTP 请求中提取出关键数据，组合成一个签名串，生成签名串的步骤如下：

1. 将所有请求参数（包括 URL 查询字符串中的所有参数与 POST 表单中的所有参数，signature 参数除外）按参数名称 ASCII 码升序排列。例如：

   ```
   排序前：foo=1, bar=2, foo_bar=3, foobar=4
   排序后：bar=2, foo=1, foo_bar=3, foobar=4
   ```

2. 将排序后的参数名称及值连接成字符串，例如：

   ```
   bar2foo1foo_bar3foobar4
   ```

3. 在连接后的字符串前添加 API 请求方法（如 POST，全大写）和路径（如 /session），例如：

   ```
   POST/sessionbar2foo1foo_bar3foobar4
   ```

### 计算签名

客户端从 HTTP 请求中提取出关键数据组装成签名串后，需要对签名串进行加密及编码处理，形成最终的签名。目前只支持 HMAC SHA-256 算法。

将上述签名串按 UTF-8 编码为字节数组后，使用 HMAC 算法（散列函数使用 SHA-256，密钥使用 APP Secret）生成签名，再将签名按十六进制小写形式转换为字符串。

### 传输签名

客户端需要将以下 4 个参数放在 URL 查询字符串中传输给 API，进行签名校验：

* k：取值为 APP Key；
* t：发送请求时的时间戳，UNIX 时间，毫秒，与 UTC 时间前后相差不得超过 15 分钟；
* z：随机字符串，推荐使用 UUID，15 分钟内不得重复；
* s：签名。

## 签名排错方法

API 签名校验失败时，测试环境下会将服务端的签名串（StringToSign）放到 HTTP 响应体的 data 中返回到客户端，Key为：string-to-sign，用户只需要将本地计算的签名串（StringToSign）与服务端返回的签名串进行对比即可找到问题。如果服务端与客户端的签名串（StringToSign）一致请检查用于签名计算的 APP Secret 是否正确。

## 签名各语言实现示例

_未完待续。_